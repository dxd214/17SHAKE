# swift高效的原因

【知识点介绍】

函数的派发机制：
静态派发(static dispatch): 是在编译期就能确定的调用方法的派发方式
动态派发(dynamic dispatch): 动态派发是指编译期无法确定应该调用哪个方法，需要在运行时才能确定方法的调用
消息派发(message dispatch): ObjC采用了运行时采用obj_msgsend进行消息派发，所以Objc的一些动态特性在Swift里面也可以被限制的使用

静态派发相比于动态派发更快，而且静态派发还会进行内联等优化，减少函数的寻址及内存地址的偏移计算等操作，使函数的执行速度更快，性能更高

一、高效的数据类型

1、数据类型(struct/class)
内存分配可以分为堆区和栈区，由于栈区内存是连续的，内存的分配和销毁是通过入栈和出栈操作进行的，速度要高于堆区。堆区存储高级数据类型，在数据初始化时，查找没有使用的内存，销毁时再从内存中清除，所以堆区的数据存储不一定是连续的。
类和结构体在内存分配上是不同的，基本数据类型和结构体默认分配在栈区，而像类这种高级数据类型存储在堆区，且堆区数据存储不是线程安全的，在频繁的数据读写操作时，要进行加锁操作。
我们在swift文档里面能看到对结构的描述，结构体是值类型(Value Type)，当值类型的数据赋值给一个变量或常量，或者传递给一个函数时，是值拷贝；
结构体除了属性的存储更安全、效率更高之外，其函数的派发也更高效。由于结构体不能被继承，也就是结构体的类型被final修饰，根据我们对于动态派发及静态派发的描述，那么其内部函数应该是属于静态派发，在编译期就确定了函数的执行方式，其函数的调用通过内联(inline)的方式进行优化，其内存连续，减少了函数的寻址及内存地址的偏移计算，其运行相比于动态派发更加高效。

2、协议类型(protocol type)
多态是面向对象的一大特性，在结构体中不能通过继承或者引用语言的多态，swift就引入了协议(protocol)，通过协议来实现了结构体的多态特性，这也是swift面向协议编程的核心所在。
对于类(class)来说，每个类都会创建一个虚拟函数表指针，这个指针则指向一个v-table表，也就是虚函数表，表内存储着该类的函数指针数组，拥有继承关系的子类会在虚函数表内通过继承顺序(C++可以实现多继承)去展示虚函数表指针。类里面方法的派发则是根据v-table表里面函数指针来进行派发。
而结构体(struct)没有继承，也就是说结构体并没有v-table表用于函数的派发。为了实现这一特性，在结构体的协议(protocol)的实现里添加了Protocol Witness Table用于管理协议类型的方法派发。


二、编译过程
1、编译过程中引入SIL（Swift Intermediate Language），为了优化swift编译过程而设计的中间语言，主要包含：
1> 一系列的高级别优化保障，用于对运行时和诊断行为提供可预测的基线；
2> 对swift语言数据流分析强制要求，对不满足强制要求的问题产生诊断。例如变量和结构体必须明确初始化，代码可达性即方法return的检测，switch的覆盖率；
3> 确保高级别优化。包含retain/release优化，动态方法的去虚拟化，闭包内联，内存初始化提升和泛型方法实例化.
4> 可用于分配"脆弱"内联的稳定分配格式，将Swift库组件的泛型优化为二进制。

